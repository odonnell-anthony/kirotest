{% extends "base.html" %}

{% block title %}
{% if document %}Edit: {{ document.title }}{% else %}New Document{% endif %} - Wiki Documentation App
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/editor.css">
<!-- CodeMirror for markdown editing -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/github-dark.min.css">
<!-- Quill for WYSIWYG editing -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Emoji picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.4/picker.css">
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Editor Header -->
    <div class="editor-header">
        <div class="editor-title-section">
            <input type="text" 
                   id="documentTitle" 
                   class="editor-title-input" 
                   placeholder="Document Title"
                   value="{{ document.title if document else '' }}"
                   maxlength="255"
                   required>
            <div class="title-error" id="titleError"></div>
        </div>
        
        <div class="editor-controls">
            <div class="editor-mode-toggle">
                <button type="button" 
                        class="mode-btn active" 
                        data-mode="markdown"
                        title="Markdown Editor">
                    📝 Markdown
                </button>
                <button type="button" 
                        class="mode-btn" 
                        data-mode="wysiwyg"
                        title="WYSIWYG Editor">
                    📄 Rich Text
                </button>
            </div>
            
            <div class="editor-actions">
                <button type="button" 
                        class="btn btn-secondary" 
                        id="previewBtn"
                        title="Preview Document">
                    👁️ Preview
                </button>
                <button type="button" 
                        class="btn btn-secondary" 
                        id="saveAsDraftBtn">
                    💾 Save Draft
                </button>
                <button type="button" 
                        class="btn" 
                        id="publishBtn">
                    🚀 Publish
                </button>
            </div>
        </div>
    </div>
    
    <!-- Editor Metadata -->
    <div class="editor-metadata">
        <div class="metadata-row">
            <div class="folder-selection">
                <label for="folderPath" class="form-label">Folder Path:</label>
                <div class="folder-input-group">
                    <input type="text" 
                           id="folderPath" 
                           class="form-control folder-path-input"
                           value="{{ document.folder_path if document else (selected_folder or '/') }}"
                           placeholder="/path/to/folder/"
                           pattern="^(/[a-zA-Z0-9_-]+)*/">
    
                <button type="button" 
                            class="btn btn-secondary folder-browse-btn"
                            title="Browse Folders">
                        📁
                    </button>
                </div>
                <div class="folder-error" id="folderError"></div>
            </div>
            
            <div class="tag-selection">
                <label for="documentTags" class="form-label">Tags:</label>
                <div class="tag-input-container">
                    <input type="text" 
                           id="tagInput" 
                           class="form-control tag-input"
                           placeholder="Add tags..."
                           autocomplete="off">
                    <div class="tag-suggestions" id="tagSuggestions"></div>
                </div>
                <div class="selected-tags" id="selectedTags">
                    {% if document and document.tags %}
                        {% for tag in document.tags %}
                            <span class="tag-item" data-tag="{{ tag.name }}">
                                {{ tag.name }}
                                <button type="button" class="tag-remove" aria-label="Remove tag">×</button>
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Editor Content -->
    <div class="editor-content">
        <!-- Markdown Editor -->
        <div class="editor-pane markdown-editor active" id="markdownEditor">
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="bold" title="Bold (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" class="toolbar-btn" data-action="italic" title="Italic (Ctrl+I)">
                        <em>I</em>
                    </button>
                    <button type="button" class="toolbar-btn" data-action="code" title="Inline Code">
                        &lt;/&gt;
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="heading1" title="Heading 1">
                        H1
                    </button>
                    <button type="button" class="toolbar-btn" data-action="heading2" title="Heading 2">
                        H2
                    </button>
                    <button type="button" class="toolbar-btn" data-action="heading3" title="Heading 3">
                        H3
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="unordered-list" title="Bullet List">
                        • List
                    </button>
                    <button type="button" class="toolbar-btn" data-action="ordered-list" title="Numbered List">
                        1. List
                    </button>
                    <button type="button" class="toolbar-btn" data-action="blockquote" title="Quote">
                        " Quote
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="link" title="Insert Link">
                        🔗 Link
                    </button>
                    <button type="button" class="toolbar-btn" data-action="image" title="Insert Image">
                        🖼️ Image
                    </button>
                    <button type="button" class="toolbar-btn" data-action="table" title="Insert Table">
                        📊 Table
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="emoji" title="Insert Emoji">
                        😀 Emoji
                    </button>
                    <button type="button" class="toolbar-btn" data-action="mermaid" title="Insert Mermaid Diagram">
                        📈 Diagram
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button type="button" class="toolbar-btn" data-action="upload" title="Upload File">
                        📎 Upload
                    </button>
                </div>
            </div>
            
            <div class="editor-textarea-container">
                <textarea id="markdownTextarea" 
                          class="editor-textarea"
                          placeholder="Start writing your document in Markdown...">{{ document.content if document else '' }}</textarea>
            </div>
        </div>
        
        <!-- WYSIWYG Editor -->
        <div class="editor-pane wysiwyg-editor" id="wysiwygEditor">
            <div id="quillEditor" class="quill-editor"></div>
        </div>
        
        <!-- Preview Pane -->
        <div class="editor-pane preview-pane" id="previewPane">
            <div class="preview-content" id="previewContent">
                <p class="preview-placeholder">Preview will appear here...</p>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="editor-status-bar">
        <div class="status-left">
            <span class="status-item" id="wordCount">Words: 0</span>
            <span class="status-item" id="charCount">Characters: 0</span>
            <span class="status-item" id="lineCount">Lines: 0</span>
        </div>
        
        <div class="status-right">
            <span class="status-item" id="saveStatus">Unsaved changes</span>
            <span class="status-item" id="lastSaved"></span>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Link Modal -->
<div class="modal" id="linkModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Insert Link</h3>
            <button type="button" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="linkText" class="form-label">Link Text:</label>
                <input type="text" id="linkText" class="form-control" placeholder="Link text">
            </div>
            <div class="form-group">
                <label for="linkUrl" class="form-label">URL:</label>
                <input type="url" id="linkUrl" class="form-control" placeholder="https://example.com">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn" id="insertLinkBtn">Insert Link</button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal" id="imageModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Insert Image</h3>
            <button type="button" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="image-upload-tabs">
                <button type="button" class="tab-btn active" data-tab="upload">Upload</button>
                <button type="button" class="tab-btn" data-tab="url">URL</button>
            </div>
            
            <div class="tab-content active" id="uploadTab">
                <div class="file-drop-zone" id="imageDropZone">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon">📁</div>
                        <p>Drop image here or click to browse</p>
                        <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">Uploading...</span>
                </div>
            </div>
            
            <div class="tab-content" id="urlTab">
                <div class="form-group">
                    <label for="imageUrl" class="form-label">Image URL:</label>
                    <input type="url" id="imageUrl" class="form-control" placeholder="https://example.com/image.jpg">
                </div>
            </div>
            
            <div class="form-group">
                <label for="imageAlt" class="form-label">Alt Text:</label>
                <input type="text" id="imageAlt" class="form-control" placeholder="Describe the image">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn" id="insertImageBtn">Insert Image</button>
        </div>
    </div>
</div>

<!-- Emoji Picker Modal -->
<div class="modal" id="emojiModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Insert Emoji</h3>
            <button type="button" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="emojiPicker"></div>
        </div>
    </div>
</div>

<!-- Mermaid Diagram Modal -->
<div class="modal" id="mermaidModal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Insert Mermaid Diagram</h3>
            <button type="button" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="mermaid-editor">
                <div class="mermaid-templates">
                    <label class="form-label">Quick Templates:</label>
                    <div class="template-buttons">
                        <button type="button" class="btn btn-secondary template-btn" data-template="flowchart">Flowchart</button>
                        <button type="button" class="btn btn-secondary template-btn" data-template="sequence">Sequence</button>
                        <button type="button" class="btn btn-secondary template-btn" data-template="gantt">Gantt</button>
                        <button type="button" class="btn btn-secondary template-btn" data-template="pie">Pie Chart</button>
                    </div>
                </div>
                
                <div class="mermaid-input">
                    <label for="mermaidCode" class="form-label">Mermaid Code:</label>
                    <textarea id="mermaidCode" 
                              class="form-control mermaid-textarea"
                              placeholder="graph TD&#10;    A[Start] --> B[Process]&#10;    B --> C[End]"
                              rows="10"></textarea>
                </div>
                
                <div class="mermaid-preview">
                    <label class="form-label">Preview:</label>
                    <div id="mermaidPreview" class="mermaid-preview-container">
                        <p class="preview-placeholder">Preview will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn" id="insertMermaidBtn">Insert Diagram</button>
        </div>
    </div>
</div>

<!-- Folder Browser Modal -->
<div class="modal" id="folderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Select Folder</h3>
            <button type="button" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="folder-tree-browser" id="folderTreeBrowser">
                <!-- Folder tree will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn" id="selectFolderBtn">Select Folder</button>
        </div>
    </div>
</div>

<!-- File Upload Input (hidden) -->
<input type="file" id="hiddenFileInput" style="display: none;" multiple>

<!-- Document Data -->
<script type="application/json" id="documentData">
{
    "id": "{{ document.id if document else '' }}",
    "title": "{{ document.title if document else '' }}",
    "content": {{ document.content|tojson if document else '""' }},
    "folder_path": "{{ document.folder_path if document else (selected_folder or '/') }}",
    "status": "{{ document.status if document else 'draft' }}",
    "tags": {{ document.tags|map(attribute='name')|list|tojson if document and document.tags else '[]' }},
    "all_tags": {{ all_tags|tojson if all_tags else '[]' }},
    "is_editing": {{ 'true' if document else 'false' }}
}
</script>
{% endblock %}

{% block extra_js %}
<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/continuelist.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>

<!-- Quill -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<!-- Marked for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>

<!-- Mermaid for diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

<!-- Emoji picker -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.4/index.js"></script>

<!-- Editor JavaScript -->
<script src="/static/js/editor.js"></script>
{% endblock %}