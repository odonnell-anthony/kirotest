{% extends "base.html" %}

{% block title %}{{ document.title }} - Wiki Documentation App{% endblock %}

{% block extra_head %}
<!-- Document meta tags -->
<meta name="document-id" content="{{ document.id }}">
{% if user %}
<meta name="current-user" content="{{ user | tojson }}">
{% endif %}

<!-- Syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" media="(prefers-color-scheme: dark)">

<!-- Mermaid diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

<!-- Document viewer styles -->
<link rel="stylesheet" href="/static/css/document.css">
{% endblock %}

{% block content %}
<div class="document-container">
    <!-- Document header -->
    <div class="document-header">
        <div class="document-meta">
            <div class="document-path">
                <span class="folder-path">{{ document.folder_path }}</span>
            </div>
            
            <div class="document-actions">
                {% if can_edit %}
                    <a href="/editor{{ document.slug }}" class="btn btn-secondary">
                        ‚úèÔ∏è Edit
                    </a>
                {% endif %}
                
                <div class="document-menu">
                    <button class="btn btn-secondary document-menu-toggle" aria-label="Document actions">
                        ‚ãØ
                    </button>
                    <div class="document-menu-dropdown">
                        <button class="menu-item" onclick="copyPageLink()">
                            üîó Copy Link
                        </button>
                        <button class="menu-item" onclick="openInNewTab()">
                            üóó Open in New Tab
                        </button>
                        {% if can_edit %}
                            <div class="menu-separator"></div>
                            <button class="menu-item" onclick="showMoveDialog()">
                                üìÅ Move Page
                            </button>
                            <button class="menu-item" onclick="showRevisionHistory()">
                                üìú Revision History
                            </button>
                            <div class="menu-separator"></div>
                            <button class="menu-item danger" onclick="deletePage()">
                                üóëÔ∏è Delete Page
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <h1 class="document-title">{{ document.title }}</h1>
        
        <div class="document-info">
            <div class="document-tags">
                {% for tag in document.tags %}
                    <a href="/search?tags={{ tag.name }}" class="tag">{{ tag.name }}</a>
                {% endfor %}
            </div>
            
            <div class="document-metadata">
                <span class="author">By {{ document.author.username }}</span>
                <span class="separator">‚Ä¢</span>
                <time datetime="{{ document.updated_at.isoformat() }}">
                    Updated {{ document.updated_at.strftime('%B %d, %Y') }}
                </time>
                {% if document.status == 'draft' %}
                    <span class="separator">‚Ä¢</span>
                    <span class="status-badge draft">Draft</span>
                {% endif %}
            </div>
        </div>
    </div>   
 <!-- Document content -->
    <div class="document-content">
        <article class="markdown-content" id="document-content">
            {{ document.content | markdown | safe }}
        </article>
    </div>
    
    <!-- Table of contents (generated from headings) -->
    <div class="document-toc">
        <div class="toc-header">
            <h3>Table of Contents</h3>
            <button class="toc-toggle" onclick="toggleToc()">‚àí</button>
        </div>
        <nav class="toc-nav" id="toc-nav">
            <!-- Generated by JavaScript -->
        </nav>
    </div>
    
    <!-- Comments section -->
    {% if user %}
        <div class="comments-section" id="comments-section">
            <div class="comments-header">
                <h2>Comments</h2>
                <span class="comment-count">{{ comments|length }} comments</span>
            </div>
            
            <!-- Add comment form -->
            <div class="add-comment">
                <form id="add-comment-form" onsubmit="addComment(event)">
                    <div class="comment-input-container">
                        <textarea 
                            id="comment-content" 
                            name="content" 
                            placeholder="Add a comment..." 
                            rows="3"
                            required
                        ></textarea>
                        <div class="comment-actions">
                            <button type="button" class="btn btn-secondary" onclick="cancelComment()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                üí¨ Comment
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Comments list -->
            <div class="comments-list" id="comments-list">
                {% for comment in comments %}
                    {% include 'partials/comment.html' %}
                {% endfor %}
                
                {% if not comments %}
                    <div class="no-comments">
                        <p>No comments yet. Be the first to comment!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="comments-section">
            <div class="comments-header">
                <h2>Comments</h2>
            </div>
            <div class="login-prompt">
                <p><a href="/login">Sign in</a> to view and add comments.</p>
            </div>
        </div>
    {% endif %}
</div>

<!-- Revision history modal -->
<div id="revision-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Revision History</h3>
            <button class="modal-close" onclick="closeRevisionModal()">&times;</button>
        </div>
        <div class="modal-body" id="revision-list">
            <!-- Loaded dynamically -->
        </div>
    </div>
</div>

<!-- Move page modal -->
<div id="move-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Move Page</h3>
            <button class="modal-close" onclick="closeMoveModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="move-form" onsubmit="movePage(event)">
                <div class="form-group">
                    <label for="new-folder-path">New Folder Path:</label>
                    <input type="text" id="new-folder-path" name="folder_path" 
                           value="{{ document.folder_path }}" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMoveModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Move Page
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="/static/js/document.js"></script>
{% endblock %}